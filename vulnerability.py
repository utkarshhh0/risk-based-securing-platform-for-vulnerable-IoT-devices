"""
Vulnerability detection using deterministic risk engine
All detection is rule-based, no randomness
"""
from typing import Dict, List
from risk_engine import calculate_risk_score, explain_risk


def analyze_device(device: Dict, policy: Dict) -> Dict:
    """
    Perform complete deterministic vulnerability analysis on a device.
    Uses risk_engine for all calculations.
    """
    # Calculate risk using deterministic engine
    risk_result = calculate_risk_score(device, policy)
    
    # Convert triggered rules to vulnerability format
    vulnerabilities = []
    
    for rule in risk_result['triggered_rules']:
        vuln = {
            'type': rule['rule'],
            'severity': rule['severity'],
            'description': rule['description'],
            'risk_contribution': rule['risk_added']
        }
        
        # Add specific details based on rule type
        if 'default_credentials' in rule['rule']:
            simulator_data = device.get('simulator_data', {})
            vuln['username'] = 'admin'  # Common default
            vuln['password'] = 'admin'  # Common default
            vuln['type'] = 'default_credentials'
        
        elif 'telnet' in rule['rule']:
            vuln['port'] = 23
            vuln['type'] = 'risky_port'
            vuln['service'] = 'telnet'
        
        elif 'rtsp' in rule['rule']:
            vuln['port'] = 554
            vuln['type'] = 'risky_port'
            vuln['service'] = 'rtsp'
        
        elif 'ftp' in rule['rule']:
            vuln['port'] = 21
            vuln['type'] = 'risky_port'
            vuln['service'] = 'ftp'
        
        elif 'http' in rule['rule']:
            simulator_data = device.get('simulator_data', {})
            open_ports = device.get('open_ports', [])
            if 80 in open_ports:
                vuln['port'] = 80
            elif 8080 in open_ports:
                vuln['port'] = 8080
            vuln['type'] = 'risky_port'
            vuln['service'] = 'http'
        
        elif 'firmware' in rule['rule']:
            simulator_data = device.get('simulator_data', {})
            years_old = risk_result.get('years_old_firmware', 0)
            if years_old >= 5:
                vuln['type'] = 'eol_firmware'
            else:
                vuln['type'] = 'outdated_firmware'
            vuln['years_old'] = years_old
            vuln['last_update_year'] = simulator_data.get('last_update_year')
        
        elif 'cve' in rule['rule']:
            vuln['type'] = 'cve'
            # Extract CVE ID from description
            desc = rule['description']
            if 'CVE-' in desc:
                cve_id = desc.split(':')[0]
                vuln['cve_id'] = cve_id
        
        vulnerabilities.append(vuln)
    
    # Get device info
    simulator_data = device.get('simulator_data', {})
    
    return {
        'device': device,
        'vulnerabilities': vulnerabilities,
        'risk_score': risk_result['risk_score'],
        'risk_category': risk_result['risk_category'],
        'risk_details': risk_result,
        'explanation': explain_risk(device, risk_result),
        'analyzed_at': risk_result.get('analyzed_at', '')
    }
